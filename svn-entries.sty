\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{svn-entries}
  [2009/03/23 v0.1 TeX Parser for Subversion entries files]

\newread\svne@read
\def\svne@gtempa{}
\def\svne@gtempb{}

\def\svn@ifeof#1{%
  \ifeof#1%
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
}

\begingroup
\catcode`\^^L=12
\gdef\svne@ff{^^L}
\endgroup

\newcommand*{\svne@catcodes}{%
  \let\do\@makeother
  \catcode`\^^L=12
  \dospecials
}

\def\svne@gobblerest{%
  \ifeof\svne@read
    \let\next\relax
  \else
    \read\svne@read to \svne@line
    \ifx\svne@line\svne@ff
      \let\next\relax
    \else
      \let\next\svne@gobblerest
    \fi
  \fi
  \next
}

\def\svne@readline#1{%
  \ifeof\svne@read
    \def#1{}%
  \else
    \read\svne@read to #1\relax
  \fi
}

\def\svne@gobblesix{%
  \begingroup
  \read\svne@read to \svne@line
  \read\svne@read to \svne@line
  \read\svne@read to \svne@line
  \read\svne@read to \svne@line
  \read\svne@read to \svne@line
  \read\svne@read to \svne@line
  \endgroup
}

\def\svne@endread{%
  \closein\svne@read
}

\newcommand*{\svne@parseentriesfile}[1]{%
  \begingroup
    \let\next\relax
    \endlinechar=-1%
    % open format file
    \openin\svne@read=#1format\relax
    \ifeof\svne@read\else
      % if exists:
      \svne@readline\svne@version
      \closein\svne@read
      % and format>7
      \ifnum\svne@version>7\relax
        % open entries file
        \openin\svne@read=#1entries\relax
        \ifeof\svne@read\else
          % if exists:
          \svne@catcodes
          \svne@readline\svne@version
          % check format version again:
          \ifnum\svne@version>7\relax
            \def\next{\svne@parsedirentry%
                      \svne@parseentries}
          \else
            \closein\svne@read
          \fi
        \fi
      \fi
    \fi
    \next
  \endgroup
}


\newcommand*{\svne@parsedirentry}{%
  \svne@readline\svne@name
  \svne@readline\svne@kind
  \svn@ifempty{\svne@name}%
    {\svn@ifequal{\svne@kind}{dir}%
      {%
        \svne@readline\svne@ignore
        \svne@readline\svne@baseurl
        \svne@gobblerest
      }{}%
    }{}%
}

\def\svne@scandate#1{\expandafter\svne@scandate@#1\relax}
\def\svne@scandate@#1-#2-#3T#4:#5:#6.#7\relax{%
  \gdef\svnfileyear{#1}%
  \gdef\svnfilemonth{#2}%
  \gdef\svnfileday{#3}%
  \gdef\svnfilehour{#4}%
  \gdef\svnfileminute{#5}%
  \gdef\svnfilesecond{#6}%
  \gdef\svnfiletimezonehour{+00}%
  \gdef\svnfiletimezoneminute{00}%
  \gdef\svnfiledate{#1-#2-#3 #4:#5:#6Z}%
  \def\svne@date{#1-#2-#3 #4:#5:#6Z}%
}

\newcommand*{\svne@parseentries}{%
  \svn@ifeof{\svne@read}%
  {}%
  {%
    \svne@readline\svne@name
    \@onelevel@sanitize\svne@name
    \svn@ifeof{\svne@read}%
    {}%
    {%
    \svne@readline\svne@kind
    \svn@ifequal{\svne@kind}{file}%
      {%
      \svne@gobblesix
      \svne@readline\svne@date
      \svne@readline\svne@rev
      \svne@readline\svne@author
      \svne@scandate{\svne@date}%
      \edef\svne@url{\svne@baseurl/\svne@name}%
      \svne@handleentry
      }{}%
    \svne@gobblerest
    \svne@parseentries
    }%
  }%
}


\def\svnegetfile#1#2{%
  \svn@getfilename{#2}%
  \edef\svnfilefname{\svnfilefname}%
  \@onelevel@sanitize\svnfilefname
  \def\svne@handleentry{%
    \svn@ifequal{\svne@name}{\svnfilefname}%
      {%
        \svnkwdef{Filename}{\svne@name}%
        \svnkwdef{Date}{\svne@date}%
        \svnkwdef{Revision}{\svne@rev}%
        \svnkwdef{Author}{\svne@author}%
        \svnkwdef{HeadURL}{\svne@url}%
        \@svn@updateid{\svne@rev}{\svne@date}{\svne@author}{\svne@url}%
        \svnexternalfile[#1]{#2}%
        \svne@endread
      }{}%
  }%
  \svne@parseentriesfile{\svnfiledir .svn/}%
  \svne@parseentriesfile{\svnfiledir _svn/}%
}



\svnmulti@atbegininputfile{%
  \svnegetfile{\svn@g}{\svn@filepath}%
}

\AtBeginDocument{%
  \svnegetfile{\svn@g}{\jobname.tex}%
}

\renewcommand*{\svnexternal}[2][\svn@g]{%
  \svn@pushfilestack
  \edef\svn@eg{#1}%
  \svne@@external#2\relax
  \svn@popfilestack
}

\def\svne@@external#1{%
  \ifx\relax#1\empty\else
    \svnegetfile{\svn@eg}{#1}%
    \expandafter\svne@@external
  \fi
}

\endinput
%EOF

