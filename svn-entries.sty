\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{svn-entries}
  [2009/03/23 v0.1 TeX Parser for Subversion entries files]

% Preliminary Declarations:
% The following declarations are needed to process the package options.

% Options:

% Other General Declarations:
%\RequirePackage[options]{package}[2009/12/13]
%\RequirePackageWithOptions{package}[2009/12/13] % load with all local options

\newread\svne@read
\def\svne@gtempa{}
\def\svne@gtempb{}

\begingroup
\catcode`\^^L=12
\gdef\svne@ff{^^L}
\endgroup

\newcommand*{\svne@catcodes}{%
  \let\do\@makeother
  \catcode`\^^L=12
  \dospecials
}

% Package macros:
\newcommand*{\svne@getformat}[1]{%
  \IfFileExists{#1}{%
    \begingroup
      \openin\svne@read=#1\relax
      \endlinechar=-1%
      \svne@catcodes
      \global\read\svne@read to \svne@gtempa
      \closein\svne@read
    \endgroup
    \let\svneformat\svne@gtempa
  }{%
    \def\svneformat{0}%
  }%
}

\def\svne@readentriesline{%
  \ifeof\svne@read\else
    \read\svne@read to \svne@line
    \ifx\svne@line\svne@ff
      \xdef\svne@gtempa{\svne@gtempa^^J{\svne@entry}}%
      \def\svne@entry{}%
    \else
      \edef\svne@entry{\svne@entry{\svne@line}}%
    \fi
  \fi
  \ifeof\svne@read\else
    \expandafter\svne@readentriesline
  \fi
}

\newcommand*{\svne@getentries}[1]{%
  \IfFileExists{#1}{%
    \begingroup
      \def\svne@gtempa{}%
      \def\svne@entry{}%
      \openin\svne@read=#1\relax
      \endlinechar=-1%
      \svne@catcodes
      \svn@catcodes
      \global\read\svne@read to \svne@gtempb
      \svne@readentriesline
      \closein\svne@read
    \endgroup
    \edef\svneentriesformat{\svne@gtempb{}}%
    \edef\svneentries{\svne@gtempa{}}%
  }{%
    \def\svneentries{}%
  }%
}

\def\svne@gobblerest{%
  \ifeof\svne@read
    \let\next\relax
  \else
    \read\svne@read to \svne@line
    \ifx\svne@line\svne@ff
      \let\next\relax
    \else
      \let\next\svne@gobblerest
    \fi
  \fi
  \next
}

\def\svne@readline#1{%
  \ifeof\svne@read
    \def#1{}%
  \else
    \read\svne@read to #1\relax
  \fi
}

\def\svne@gobblesix{%
  \read\svne@read to \svne@ignore
  \read\svne@read to \svne@ignore
  \read\svne@read to \svne@ignore
  \read\svne@read to \svne@ignore
  \read\svne@read to \svne@ignore
  \read\svne@read to \svne@ignore
}

\def\svne@endread{%
  \closein\svne@read
}

\newcommand*{\svne@parseentriesfile}[1]{%
  \IfFileExists{#1}{%
    \begingroup
      \openin\svne@read=#1\relax
      \endlinechar=-1%
      \svne@catcodes
      \svne@readline\svne@version
      \ifnum\svne@version>7\relax
        \expandafter
        \svne@parsedirentry
        \expandafter
        \svne@parseentries
      \fi
      \closein\svne@read
    \endgroup
  }{}%
}

\def\svne@dir{dir}
\def\svne@file{file}

\newcommand*{\svne@parsedirentry}{%
  \svne@readline\svne@name
  \svne@readline\svne@kind
  \ifx\svne@name\empty
    \ifx\svne@kind\svne@dir
      \svne@readline\svne@ignore
      \global
      \svne@readline\svne@baseurl
      \svne@gobblerest
    \fi
  \fi
}

\def\svne@scandate#1{\expandafter\svne@scandate@#1\relax}

% 2009-03-19T18:08:07.052260Z
\def\svne@scandate@#1-#2-#3T#4:#5:#6.#7\relax{%
  \gdef\svnfileyear{#1}%
  \gdef\svnfilemonth{#2}%
  \gdef\svnfileday{#3}%
  \gdef\svnfilehour{#4}%
  \gdef\svnfileminute{#5}%
  \gdef\svnfilesecond{#6}%
  \gdef\svnfiletimezonehour{+00}%
  \gdef\svnfiletimezoneminute{00}%
  \gdef\svnfiledate{#1-#2-#3 #4:#5:#6Z}%
  \def\svne@date{#1-#2-#3 #4:#5:#6Z}%
}

\newcommand*{\svne@parseentries}{%
  \ifeof\svne@read
    \expandafter\@gobble
  \else
    \expandafter\@firstofone
  \fi
  {%
    \svne@readline\svne@name
    \@onelevel@sanitize\svne@name
    \ifeof\svne@read
      \expandafter\@gobble
    \else
      \expandafter\@firstofone
    \fi
    {%
    \svne@readline\svne@kind
    \ifx\svne@kind\svne@file
      \svne@gobblesix
      \svne@readline\svne@date
      \svne@readline\svne@rev
      \svne@readline\svne@author
      \svne@scandate{\svne@date}%
      \edef\svne@url{\svne@baseurl/\svne@name}%
      \expandafter
      \svne@handleentry
    \fi
    \svne@gobblerest
    \svne@parseentries
    }%
  }%
}

% \begin{macro}{\svn@ifempty}[1]{string}
% Tests if the given argument is empty. If so the first of the next two token
% will be expanded, the second one otherwise.
%    \begin{macrocode}
\def\svn@ifempty#1{%
  \begingroup
  \edef\svn@temp{#1}%
  \ifx\svn@temp\empty
    \endgroup
    \expandafter
    \@firstoftwo
  \else
    \endgroup
    \expandafter
    \@secondoftwo
  \fi
}
%    \end{macrocode}
% \end{macro}
% \begin{macro}{\svn@getfilename}[1]{URL}
% This macro expands the content using the temporary macro and sets it in front
% of the \csi{svn@getfilename} sub-macro together with |/{}| to make sure the
% macro does not break at values without directories. A |\relax| is used as
% end marker.
%    \begin{macrocode}
\def\svn@getfilename#1{%
  \begingroup
    \gdef\svnfilepath{}%
    \edef\svn@temp{#1}%
    \expandafter\@svn@getfilename\svn@temp/{}\relax
}%
%    \end{macrocode}
% \end{macro}

% \begin{macro}{\@svn@getfilename}[2]{URL part before first slash}{URL part after
% first slash}
% Splits the content at the first slash (|/|) and checks if the remainder is
% empty. If so the end marker got reached and the part before the slash is the
% filename which is returned. Otherwise the macro recursively calls itself to
% split the remainder.
%    \begin{macrocode}
\def\@svn@getfilename#1/#2\relax{%
  \svn@ifempty{#2}%
    {%
      \endgroup
      \gdef\svnfilefname{#1}%
    }%
    {%
      \xdef\svnfilepath{\svnfilepath#1/}%
      \@svn@getfilename#2\relax
    }%
}%
%    \end{macrocode}
% \end{macro}

\newcommand*{\svne@handleentry}{%
  % check if entry is wanted
  % Parsing can be stopped by calling \svne@endread
  \message{^^J%
Name: \svne@name^^J%
Date: \svne@date^^J%
Rev: \svne@rev^^J%
Author: \svne@author^^J%
URL: \svne@url^^J%
  }
}

\def\svnegetfile#1{%
  \svn@getfilename{#1}%
  \@onelevel@sanitize\svnfilefname
  \renewcommand*{\svne@handleentry}{%
    \ifx\svne@name\svnfilefname
      \message{^^J%
        Name: \svne@name^^J%
        Date: \svne@date^^J%
        Rev: \svne@rev^^J%
        Author: \svne@author^^J%
        URL: \svne@url^^J%
      }
      \svnkwdef{Filename}{\svne@name}%
      \svnkwdef{Date}{\svne@date}%
      \svnkwdef{Revision}{\svne@rev}%
      \svnkwdef{Author}{\svne@author}%
      \svnkwdef{HeadURL}{\svne@url}%
      \@svn@updateid{\svne@rev}{\svne@date}{\svne@author}{\svne@url}%
      \expandafter\svnexternalfile\expandafter{#1}%
      \svne@endread
    \fi
  }%
  \svne@parseentriesfile{\svnfilepath _svn/entries}
  \svne@parseentriesfile{\svnfilepath .svn/entries}
}

%\svnmulti@atbegininputfile{%
\AtBeginDocument{%
  \svnegetfile{\jobname.tex}%
}

\def\svnexternal#1{%
  \svn@pushfilestack
  \svne@@external#1\relax
  \svn@popfilestack
}

\def\svne@@external#1{%
  \ifx\relax#1\empty\else
    \svnegetfile{#1}%
    \expandafter\svne@@external
  \fi
}

\endinput
%EOF

